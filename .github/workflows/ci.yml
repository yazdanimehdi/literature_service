# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25'
  GOLANGCI_LINT_VERSION: 'v1.62.0'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum
      - run: go mod download
      - uses: golangci/golangci-lint-action@v6
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=5m

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum
      - run: go mod download
      - name: Run unit tests
        run: go test -v -race -short -coverprofile=coverage.out -covermode=atomic ./...
      - name: Generate coverage report
        run: go tool cover -func=coverage.out
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.out
          flags: unittests
          fail_ci_if_error: false

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      TEST_DB_USER: testuser
      TEST_DB_PASS: testpass
      TEST_DB_NAME: testdb
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go mod download
      - name: Mask credentials
        run: |
          echo "::add-mask::$TEST_DB_USER"
          echo "::add-mask::$TEST_DB_PASS"
      - name: Run integration tests
        env:
          LITREVIEW_DATABASE_HOST: localhost
          LITREVIEW_DATABASE_PORT: 5432
          LITREVIEW_DATABASE_USER: testuser
          LITREVIEW_DATABASE_PASSWORD: testpass
          LITREVIEW_DATABASE_NAME: testdb
          LITREVIEW_DATABASE_SSL_MODE: disable
        run: |
          go test -v -race -tags=integration -timeout 20m \
            -coverprofile=coverage-integration.out ./tests/integration/...

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go mod download
      - uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif
        if: always()
      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... || true

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        goos: [linux]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go mod download
      - name: Build binaries
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
          COMMIT_SHA: ${{ github.sha }}
        run: |
          go build -ldflags="-s -w -X main.Version=$COMMIT_SHA" \
            -o "bin/server-$GOOS-$GOARCH" ./cmd/server
          go build -ldflags="-s -w -X main.Version=$COMMIT_SHA" \
            -o "bin/worker-$GOOS-$GOARCH" ./cmd/worker
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: bin/
          retention-days: 7

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: literature-review-service:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'literature-review-service:test'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, integration-test, security-scan, build, docker-build]
    if: always()
    steps:
      - name: Check results
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
          INTEGRATION_RESULT: ${{ needs.integration-test.result }}
          SECURITY_RESULT: ${{ needs.security-scan.result }}
          BUILD_RESULT: ${{ needs.build.result }}
          DOCKER_RESULT: ${{ needs.docker-build.result }}
        run: |
          echo "Lint: $LINT_RESULT"
          echo "Tests: $TEST_RESULT"
          echo "Integration: $INTEGRATION_RESULT"
          echo "Security: $SECURITY_RESULT"
          echo "Build: $BUILD_RESULT"
          echo "Docker: $DOCKER_RESULT"
      - name: Fail if critical jobs failed
        if: |
          needs.lint.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.docker-build.result == 'failure'
        run: exit 1
