# syntax=docker/dockerfile:1
#
# literature_service — All-in-one local development container
# Bundles: PostgreSQL 15 + Temporal dev server + Kafka (KRaft) + Qdrant
#          + literature-review-server + literature-review-worker
#
# Build context: monorepo root (for replace directives: grpcauth, outbox, ingestion_service)
#
# Build:  make local-up   (from literature_service/)
# Stop:   make local-down

# ==========================================================================
# Stage 1: Build the Go binaries
# ==========================================================================
FROM golang:1.25-alpine AS builder

RUN apk add --no-cache git ca-certificates tzdata

WORKDIR /build

COPY grpcauth/          /build/grpcauth/
COPY outbox/            /build/outbox/
COPY ingestion_service/ /build/ingestion_service/
COPY llm/               /build/llm/

COPY literature_service/go.mod literature_service/go.sum /build/literature_service/
WORKDIR /build/literature_service
RUN go mod download

COPY literature_service/ /build/literature_service/

ARG VERSION=dev
ARG BUILD_TIME
ARG COMMIT_SHA

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags "-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.CommitSHA=${COMMIT_SHA}" \
    -o /build/bin/literature-review-server ./cmd/server

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags "-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.CommitSHA=${COMMIT_SHA}" \
    -o /build/bin/literature-review-worker ./cmd/worker

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags "-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.CommitSHA=${COMMIT_SHA}" \
    -o /build/bin/literature-review-migrate ./cmd/migrate

# ==========================================================================
# Stage 2: Minimal runtime for docker-compose
# ==========================================================================
FROM alpine:3.19 AS compose

RUN apk add --no-cache ca-certificates tzdata
WORKDIR /app
COPY --from=builder /build/bin/literature-review-server  /app/literature-review-server
COPY --from=builder /build/bin/literature-review-worker  /app/literature-review-worker
COPY --from=builder /build/bin/literature-review-migrate /app/literature-review-migrate
COPY --from=builder /build/literature_service/migrations /app/migrations
COPY --from=builder /build/literature_service/config     /app/config
EXPOSE 8080 9090 9091
ENTRYPOINT ["/app/literature-review-server"]

# ==========================================================================
# Stage 3: Runtime — all services in one container
# ==========================================================================
FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
        postgresql-15 \
        postgresql-client-15 \
        supervisor \
        ca-certificates \
        tzdata \
        curl \
        wget \
    && rm -rf /var/lib/apt/lists/*

# Remove auto-created PostgreSQL data directory so entrypoint init is not skipped
RUN rm -rf /var/lib/postgresql/15/main/*

# Install JRE for Kafka
RUN apt-get update && apt-get install -y --no-install-recommends \
        default-jre-headless \
    && rm -rf /var/lib/apt/lists/*

# Install Temporal CLI
ARG TEMPORAL_VERSION=1.1.2
RUN curl -L -o /tmp/temporal.tar.gz \
        "https://github.com/temporalio/cli/releases/download/v${TEMPORAL_VERSION}/temporal_cli_${TEMPORAL_VERSION}_linux_amd64.tar.gz" \
    && tar -xzf /tmp/temporal.tar.gz -C /usr/local/bin/ \
    && rm /tmp/temporal.tar.gz \
    && chmod +x /usr/local/bin/temporal

# Install Apache Kafka (KRaft mode)
ARG KAFKA_VERSION=3.7.0
ARG SCALA_VERSION=2.13
RUN curl -L -o /tmp/kafka.tgz \
        "https://archive.apache.org/dist/kafka/${KAFKA_VERSION}/kafka_${SCALA_VERSION}-${KAFKA_VERSION}.tgz" \
    && mkdir -p /opt/kafka \
    && tar -xzf /tmp/kafka.tgz -C /opt/kafka --strip-components=1 \
    && rm /tmp/kafka.tgz

# Install Qdrant (platform-aware)
ARG QDRANT_VERSION=1.12.6
ARG TARGETARCH
RUN QDRANT_ARCH=$(if [ "$TARGETARCH" = "arm64" ]; then echo "aarch64"; else echo "x86_64"; fi) \
    && curl -L -o /tmp/qdrant.tar.gz \
        "https://github.com/qdrant/qdrant/releases/download/v${QDRANT_VERSION}/qdrant-${QDRANT_ARCH}-unknown-linux-musl.tar.gz" \
    && tar -xzf /tmp/qdrant.tar.gz -C /usr/local/bin/ \
    && rm /tmp/qdrant.tar.gz \
    && chmod +x /usr/local/bin/qdrant

RUN mkdir -p /data/kafka /data/temporal /data/qdrant/storage /etc/qdrant

COPY <<'QDRANT_CONFIG' /etc/qdrant/config.yaml
storage:
  storage_path: /data/qdrant/storage
service:
  grpc_port: 6334
  http_port: 6333
QDRANT_CONFIG

COPY --from=builder /build/bin/literature-review-server  /app/literature-review-server
COPY --from=builder /build/bin/literature-review-worker  /app/literature-review-worker
COPY --from=builder /build/bin/literature-review-migrate /app/literature-review-migrate
COPY --from=builder /build/literature_service/migrations /app/migrations
COPY --from=builder /build/literature_service/config     /app/config

ENV PGDATA=/var/lib/postgresql/15/main
ENV POSTGRES_USER=litreview
ENV POSTGRES_PASSWORD=devpassword
ENV POSTGRES_DB=litreview

ENV LITREVIEW_DATABASE_HOST=127.0.0.1
ENV LITREVIEW_DATABASE_PORT=5432
ENV LITREVIEW_DATABASE_NAME=litreview
ENV LITREVIEW_DATABASE_USER=litreview
ENV LITREVIEW_DATABASE_PASSWORD=devpassword
ENV LITREVIEW_DATABASE_SSL_MODE=disable
ENV LITREVIEW_TEMPORAL_HOST_PORT=127.0.0.1:7233
ENV LITREVIEW_KAFKA_BROKERS=127.0.0.1:9092
ENV LITREVIEW_QDRANT_ADDRESS=127.0.0.1:6334
ENV LITREVIEW_LLM_OPENAI_API_KEY=sk-placeholder

# Kafka KRaft configuration
COPY <<'KRAFT_CONFIG' /opt/kafka/config/kraft-server.properties
process.roles=broker,controller
node.id=1
controller.quorum.voters=1@localhost:29093
listeners=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093
advertised.listeners=PLAINTEXT://localhost:9092
controller.listener.names=CONTROLLER
inter.broker.listener.name=PLAINTEXT
log.dirs=/data/kafka
num.partitions=3
offsets.topic.replication.factor=1
transaction.state.log.replication.factor=1
transaction.state.log.min.isr=1
group.initial.rebalance.delay.ms=0
auto.create.topics.enable=true
log.retention.hours=168
KRAFT_CONFIG

COPY <<'SUPERVISOR' /etc/supervisor/conf.d/services.conf
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[program:postgresql]
command=/usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/15/main
user=postgres
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:temporal]
command=/usr/local/bin/temporal server start-dev --ip 0.0.0.0 --db-filename /data/temporal/default.db --log-format pretty --namespace literature-review
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20

[program:kafka]
command=/opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft-server.properties
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20

[program:qdrant]
command=/usr/local/bin/qdrant --config-path /etc/qdrant/config.yaml
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20

[program:litreview-server]
command=/app/literature-review-server
autostart=true
autorestart=true
startsecs=15
startretries=30
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=30

[program:litreview-worker]
command=/app/literature-review-worker
autostart=true
autorestart=true
startsecs=15
startretries=30
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=30
SUPERVISOR

COPY <<'ENTRYPOINT_SCRIPT' /entrypoint.sh
#!/bin/bash
set -e

echo "=== literature_service all-in-one container ==="

if [ ! -f "$PGDATA/PG_VERSION" ]; then
    echo "[init] Initializing PostgreSQL..."
    su - postgres -c "/usr/lib/postgresql/15/bin/initdb -D $PGDATA"

    echo "host all all 0.0.0.0/0 md5" >> "$PGDATA/pg_hba.conf"
    echo "local all all trust" >> "$PGDATA/pg_hba.conf"
    sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/" "$PGDATA/postgresql.conf"

    su - postgres -c "/usr/lib/postgresql/15/bin/pg_ctl -D $PGDATA -w start"
    su - postgres -c "psql -c \"CREATE USER $POSTGRES_USER WITH PASSWORD '$POSTGRES_PASSWORD' SUPERUSER;\""
    su - postgres -c "psql -c \"CREATE DATABASE $POSTGRES_DB OWNER $POSTGRES_USER;\""
    su - postgres -c "/usr/lib/postgresql/15/bin/pg_ctl -D $PGDATA -w stop"
    echo "[init] PostgreSQL initialized."
fi

if [ ! -f "/data/kafka/meta.properties" ]; then
    echo "[init] Formatting Kafka KRaft storage..."
    CLUSTER_ID=$(/opt/kafka/bin/kafka-storage.sh random-uuid)
    /opt/kafka/bin/kafka-storage.sh format -t "$CLUSTER_ID" -c /opt/kafka/config/kraft-server.properties
    echo "[init] Kafka KRaft storage formatted."
fi

echo "[init] Starting all services (PostgreSQL, Temporal, Kafka, Qdrant, server, worker)..."
exec /usr/bin/supervisord -c /etc/supervisor/supervisord.conf
ENTRYPOINT_SCRIPT

RUN chmod +x /entrypoint.sh && mkdir -p /var/log/supervisor

EXPOSE 8080 9090 9091 5432 7233 8233 9092 6333 6334

ENTRYPOINT ["/entrypoint.sh"]
